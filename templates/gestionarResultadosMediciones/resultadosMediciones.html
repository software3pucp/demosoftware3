{% extends 'base/base.html' %}

{% load static %}
{#Bloque de extra style -> css#}
{% block extrastyle %}
    <style>
        #container {
          margin: 20px;
          width: 200px;
          height: 200px;
          position: relative;
        }
    </style>
{% endblock %}

{#Bloque de extra body -> HTML#}
{% block body %}
    {#AQUI COLOQUEN EL CÓDIGO#}
    <div class="card mb-3 bg-card-gradient">
        <div class="card-body ">
            <div class="row justify-content-between align-items-center">
                <div class="col-12">
                    <h2 class="mb-2 mb-md-0 text-white">Dashboard</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-4 mb-3">
            <div class="card h-lg-100">
                <div class="card-header">
                    <div class="row align-items-center mb-3">
                        <div class="col">
                            <h5>Porcentaje de alumnos por encima de la media por indicador</h5>
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="col-auto text-center pr-card">
                            <select class="custom-select custom-select-sm">
                                <option>Indicador1</option>
                                <option>Indicador2</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="progress-circle mb-4" data-options='{"progress":96,"color": "url(#gradient)"}'></div>
                </div>
            </div>
        </div>
        <div class="col-4 mb-3">
            <div class="card h-lg-100 overflow-hidden">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5>Progreso de Indicadores</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dashboard mb-0 table-borderless fs--1">
                        <thead>
                            <tr class="text-900">
                                <th>Indicador</th>
                                <th>Progreso(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Indicador1</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-danger w-25" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Indicador2</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning w-50" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Indicador3</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-info w-75" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">75%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Indicador4</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-success w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-4 mb-3">
            <div class="card h-lg-100 overflow-hidden">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5>Progreso de Cursos por Indicador</h5>
                        </div>
                        <div class="col-auto text-center pr-card">
                            <select class="custom-select custom-select-sm">
                                <option>Indicador1</option>
                                <option>Indicador2</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dashboard mb-0 table-borderless fs--1">
                        <thead>
                            <tr class="text-900">
                                <th>Curso</th>
                                <th>Progreso(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Curso1</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-danger w-25" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Curso2</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning w-50" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Curso3</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-info w-75" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">75%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Curso4</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-success w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body ">
            <div class="row justify-content-between align-items-center">
                <div class="col-12">
                    <h5 class="mb-2 mb-md-0">Número de alumnos por nivel</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="card-deck">
        <div class="card mb-3 overflow-hidden">
            <div class="bg-holder bg-card" style="background-image:url(assets/img/illustrations/corner-1.png);"></div>
            <div class="card-body position-relative">
                <h5>Nivel1</h5>
                <div class="display-4 fs-4 mb-2 font-weight-normal text-sans-serif" data-countup='{"count":500}'></div>
            </div>
        </div>
        <div class="card mb-3 overflow-hidden">
            <div class="bg-holder bg-card" style="background-image:url(assets/img/illustrations/corner-1.png);"></div>
            <div class="card-body position-relative">
                <h5>Nivel2</h5>
                <div class="display-4 fs-4 mb-2 font-weight-normal text-sans-serif text-warning" data-countup='{"count":200}'></div>
            </div>
        </div>
        <div class="card mb-3 overflow-hidden">
            <div class="bg-holder bg-card" style="background-image:url(assets/img/illustrations/corner-1.png);"></div>
            <div class="card-body position-relative">
                <h5>Nivel3</h5>
                <div class="display-4 fs-4 mb-2 font-weight-normal text-sans-serif text-warning" data-countup='{"count":200}'></div>
            </div>
        </div>
        <div class="card mb-3 overflow-hidden">
            <div class="bg-holder bg-card" style="background-image:url(assets/img/illustrations/corner-1.png);"></div>
            <div class="card-body position-relative">
                <h5>Nivel4</h5>
                <div class="display-4 fs-4 mb-2 font-weight-normal text-sans-serif text-info" data-countup='{"count":1000}'></div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="semestres">Semestres:</label>
                    <select id="semestres" name="semestres" class="form-control" onchange="actualizarCursos()">
                        {% for semestre in semestres %}
                            <option value="{{ semestre.pk }}">{{ semestre.nombreCodigo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="cursos">Cursos:</label>
                    <select id="cursos" name="cursos" class="form-control" onchange="agregarData()">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="horarios">Horarios:</label>
                    <select id="horarios" name="horarios" class="form-control" onchange="actualizar()">
                        <option value="All">All</option>
                    </select>
                </div>
            </div>
            <div class="p-3">
                <canvas id="myChart" style="width:100%;"></canvas>
            </div>
        </div>
    </div>

{% endblock %}

{% block extrajs %}
    <script>

        var xValues = [];
        var matriz=[];

        $(document).ready(function () {
            console.log("ready!");
            actualizarCursos();
        });

        function actualizarCursos() {
            $.ajax({
                type: 'POST',
                url: "{% url 'resultadosMediciones' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    operacion: 'actualizarCursos',
                    semestre: $("#semestres").val(),
                },
                success: function (response) {
                    var instance = response["resp"];
                    $(".curso").remove();
                    for (var i = 0; i < instance.length; i++) {
                        curso = '<option class="curso" value=' +
                            instance[i]["pk"] + '>' +
                            instance[i]["curso"] + '</option>';
                        console.log(curso);
                        $("#cursos").append(curso);
                    }
                    agregarData();
                },
                error: function (response) {
                    alert(response["responseJSON"]["error"]);
                },
            });
        }

        function agregarData() {
            $.ajax({
                type: 'POST',
                url: "{% url 'resultadosMediciones' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    operacion: 'agregar',
                    curso: $("#cursos").val(),
                },
                success: function (response) {
                    var xLabel = JSON.parse(response["xLabel"]);
                    var yLabel = response["yLabel"];

                    console.log(xLabel);
                    console.log(yLabel);

                    console.log(yLabel["horarios"][0]["notas"]);
                    console.log(yLabel["horarios"][0]["notas"][3].cant);

                    grafiquito.data.datasets.pop();
                    grafiquito.data.datasets = [];

                    xValues = [];
                    grafiquito.update();

                    $(".horario").remove();
                    var dataHorario;
                    for(var i=0; i<xLabel.length; i++){
                         xValues.push(xLabel[i]["fields"].codigo);

                          dataHorario = '<option class="horario" value='+
                           xLabel[i]["fields"].codigo+'>'+ xLabel[i]["fields"].codigo+'</option>';

                        $("#horarios").append(dataHorario);
                    }

                    var prueba=[];

                    for (var i = 0; i < yLabel["horarios"].length; i++) {
                        var lineal = [];
                        for (var j = 0; j < yLabel["horarios"][i]["notas"].length; j++) {
                            lineal.push(yLabel["horarios"][i]["notas"][j].cant);
                        }
                        prueba.push(lineal);
                    }

                    console.log("PRUEBA");
                    console.log(prueba);
                    matriz = prueba[0].map((_, colIndex) => prueba.map(row => row[colIndex]));
                    console.log(matriz);

                    for(var i=0;i<matriz.length; i++){
                        const newDataset = {
                            label: 'Nivel ' + (i+1),
                            fill: false,
                            lineTension: 0,
                            backgroundColor: generateRandomColor(),
                            borderColor: generateRandomColor(),
                            data: matriz[i]
                        };
                        grafiquito.data.datasets.push(newDataset);
                    }

                    grafiquito.update();
                    actualizar();
                },
                error: function (response) {
                    alert(response["responseJSON"]["error"]);
                },
            });
        }

        function generateRandomColor() {
            var randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
            return randomColor;
            //random color will be freshly served
        }

        function actualizar() {
            grafiquito.data.labels = [$("#horarios").val()];

            var posicion=-1;
            for(var i=0; i<xValues.length; i++){
                if($("#horarios").val() == xValues[i]) posicion=i;
            }


            if ($("#horarios").val() == 'All') {
                grafiquito.data.labels = xValues;
                for (var i = 0; i < matriz.length; i++) {
                    grafiquito.data.datasets[i].data = matriz[i];
                }
            } else {
                grafiquito.data.labels = [$("#horarios").val()];
                for (var i = 0; i < matriz.length; i++) {
                    var mini = [];
                    mini.push(matriz[i][posicion]);
                    grafiquito.data.datasets[i].data = mini;
                    console.log(matriz[i][posicion]);
                }
            }
            grafiquito.update();
        }


        const data = {
            labels: xValues,
            datasets: [
            ]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Cantidad de alumnos evaluados por Horario'
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'point',
                },
                scales: {
                    y: {
                        min: 0,
                        max: 5,
                        title: {
                            display: true,
                            text: 'Cantidad de alumnos',
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                     x: {
                        title: {
                            display: true,
                            text: 'Horarios',
                        }
                     }
                },
            },
        }

        var grafiquito = new Chart("myChart", config);

    </script>
{% endblock %}